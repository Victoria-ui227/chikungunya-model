prob_transmission <- (sigma_m / ( sigma_m + mu_m))
RO <- (b^2 * beta_hm * beta_mh * prob_transmission * avg_infectious_period * avg_infectious_period_mosquito)/mu_m
return(RO)
})
}
calculate_cumulative_incidence <- function(results, params) {
# Calculate new infections over time (approximation)
results$new_infections_1 <- c(0, diff(results$E1)) * params$sigma
results$new_infections_2 <- c(0, diff(results$E2)) * params$sigma
# Cumulative incidence
results$cum_incidence_1 <- cumsum(pmax(0, results$new_infections_1))
results$cum_incidence_2 <- cumsum(pmax(0, results$new_infections_2))
return(results)
}
main_simulation <- function() {
# Define parameters
params <- list(
# Human parameters
mu = 1/(62*365),              # Human natural death rate
sigma = 1/5,                  # 1/incubation period (days)
gamma_m = 1/7,                # Recovery rate from mild infection
gamma_s = 1/14,               # Recovery rate from severe infection
gamma_c = 1/60,               # Recovery rate from chronic state (slower)
severe_prob_1 = 0.1,          # Probability of severe disease in age group 1
severe_prob_2 = 0.3,          # Probability of severe disease in age group 2
#chronic_prob_m = 0.15,        # Probability of chronic from mild infection
chronic_prob_s = 0.25,        # Probability of chronic from severe infection
mu_ms = 1/10,          # Progression rate from Im to Is (1/10 days)
#vaccination_rate_1 = 0.001,   # Vaccination rate for age group 1
#vaccination_rate_2 = 0.002,   # Vaccination rate for age group 2
contact_rate_1 = 1.0,         # Relative contact rate for age group 1
contact_rate_2 = 0.8,         # Relative contact rate for age group 2
# Proportions for age distribution in shared compartments (for demographic calculation)
prop_age1_Im = 0.8,           # Proportion of mild infectious in age group 1
prop_age1_Is = 0.7,           # Proportion of severe infectious in age group 1
prop_age1_C = 0.75,           # Proportion of chronic in age group 1
prop_age1_R = 0.8,            # Proportion of recovered in age group 1
#prop_age1_V = 0.8,            # Proportion of vaccinated in age group 1
# Mosquito parameters
Lambda_m = 1000,              # Mosquito recruitment rate
mu_m = 1/14,                  # Mosquito death rate
sigma_m = 1/7,                # 1/extrinsic incubation period
# Transmission parameters
b = 0.5,                      # Biting rate
beta_hm = 0.1,                # Transmission probability human to mosquito
beta_mh = 0.1                 # Transmission probability mosquito to human
)
# Initial conditions
N1_initial <- 1108333  # Initial population age group 1
N2_initial <- 100000  # Initial population age group 2
initial_conditions <- c(
S1 = N1_initial - 100,    # Susceptible age group 1
E1 = 0,                  # Exposed age group 1
S2 = N2_initial - 50,     # Susceptible age group 2
E2 = 0,                  # Exposed age group 2
Im = 500,                  # Infectious mild (mixed ages)
Is = 173,                  # Infectious severe (mixed ages)
C = 0,                   # Chronic
R = 0,                   # Recovered
#V = 0,                   # Vaccinated
Sm = 9000,               # Susceptible mosquitoes
Em = 500,                # Exposed mosquitoes
Im_mosq = 500            # Infectious mosquitoes
)
# Time points
time_points <- seq(0, 365*5, by = 1)
# Run simulation
cat("Running modified chikungunya simulation...\n")
results <- run_chikungunya_simulation(params, initial_conditions, time_points)
# Calculate cumulative incidence
results <- calculate_cumulative_incidence(results, params)
# Calculate RO
RO <- calculate_RO(params)
cat(sprintf("Basic reproduction number (RO): %.3f\n", RO))
# Plot results
cat("Generating plots...\n")
plot_chikungunya_results(results)
# Print final population sizes
final_results <- tail(results, 1)
cat("\nFinal population sizes:\n")
cat(sprintf("Age group 1 - S&E: %.0f\n", final_results$S1 + final_results$E1))
cat(sprintf("Age group 2 - S&E: %.0f\n", final_results$S2 + final_results$E2))
cat(sprintf("Total Infectious: %.0f\n", final_results$Im + final_results$Is))
cat(sprintf("Chronic cases: %.0f\n", final_results$C))
cat(sprintf("Recovered: %.0f\n", final_results$R))
#cat(sprintf("Vaccinated: %.0f\n", final_results$V))
cat(sprintf("Total mosquitoes: %.0f\n", final_results$Sm + final_results$Em + final_results$Im_mosq))
# Print cumulative incidence
cat(sprintf("\nCumulative incidence by end of simulation:\n"))
cat(sprintf("Age group 1: %.0f cases\n", tail(results$cum_incidence_1, 1)))
cat(sprintf("Age group 2: %.0f cases\n", tail(results$cum_incidence_2, 1)))
return(list(results = results, params = params, RO = RO))
}
analyze_chronic_burden <- function(results){
# Peak Chronic cases
peak_chronic <- max(results$C)
peak_chronic_time <- results$time[which.max(results$C)]
#Chronic prevalence over time
chronic_data <- data.frame(
time = results$time,
chronic_cases = results$C,
chronic_prevalence = results$C / (results$S1 + results$E1 + results$S2 + results$E2 +
results$Im + results$Is + results$C + results$R)
)
# Plot chronic burden
p_chronic <- ggplot(chronic_data, aes(x= time))+
geom_line(aes(y= chronic_cases, color = "Chronic Cases"), linewidth = 1.2)+
geom_line(aes(y = chronic_prevalence* 1000 , color = "Prevalence (per 1000)"),linewidth= 1.2)+
scale_y_continuous(
name = "Chronic Cases",
sec.axis = sec_axis(~./1000, name = "Prevalence (per 1000)")
)+ labs(title = "Chronic Chikungunya Burden Over Timme",
x= "Time(days)", color = "Measure")+
theme_minimal()+
theme(legend.position = "bottom")
print(p_chronic)
cat(sprintf("Peak chronic cases: %.0f at day %.0f\n", peak_chronic, peak_chronic_time))
return(chronic_data)
}
if(interactive()){
simulation_results <- main_simulation()
cat("Simulation completed successfully!\n")
#Analyze chronic disease burden
cat("\nAnalyzing chronic disease burden...\n")
chronic_analysis <- analyze_chronic_burden(simulation_results$results)
}
pacman:: p_load(GillespieSSA2,
tidyr)
# Define Parameters -------------------------------------------------------
amp_val <- 0.7
phi_val <- 0.219
PI_val  <- pi
# 2. RAINFALL DATA --------------------------------------------------------
rainfall_data <- data.frame(
month = 1:12,
rainfall = c(0.38, 1.52, 6.49, 29.32, 64.98, 109.02,
176.81, 240.86, 148.25, 49.59, 3.58, 0.25)
)
# Normalize
rainfall_data$rain_norm <- rainfall_data$rainfall / max(rainfall_data$rainfall)
params <- list(
# Human parameters
mu = 1/(62*365),              # Human natural death rate
sigma = 1/5,                  # 1/incubation period (days)
gamma_m = 1/7,                # Recovery rate from mild infection
gamma_s = 1/14,               # Recovery rate from severe infection
gamma_c = 1/60,               # Recovery rate from chronic state (slower)
severe_prob_1 = 0.1,          # Probability of severe disease in age group 1
severe_prob_2 = 0.3,          # Probability of severe disease in age group 2
#chronic_prob_m = 0.15,        # Probability of chronic from mild infection
chronic_prob_s = 0.25,        # Probability of chronic from severe infection
mu_ms = 1/5,          # Progression rate from Im to Is (1/10 days;5)
vaccination_rate_1 = 0.0015,   # Vaccination rate for age group 1
vaccination_rate_2 = 0.002,   # Vaccination rate for age group 2
contact_rate_1 = 1.0,         # Relative contact rate for age group 1
contact_rate_2 = 0.8,         # Relative contact rate for age group 2
amp = amp_val,                    #Seasonality amplitude (0-1)
phi = phi_val,                   #phase shift (0-1, fraction of year)
PI = PI_val,
import_rate = 1,
# Proportions for age distribution in shared compartments (for demographic calculation)
prop_age1_Im = 0.8,           # Proportion of mild infectious in age group 1
prop_age1_Is = 0.1,           # Proportion of severe infectious in age group 1;0.7
prop_age1_C = 0.2,           # Proportion of chronic in age group 1;0.75
prop_age1_R = 0.8,            # Proportion of recovered in age group 1
prop_age1_V = 0.8,            # Proportion of vaccinated in age group 1
# Mosquito parameters
Lambda_m = 20000,              # Mosquito recruitment rate;20000
mu_m = 1/14,                  # Mosquito death rate;14
sigma_m = 1/3,                # 1/extrinsic incubation period;7
# Transmission parameters
b = 0.8,                      # Biting rate; 1
beta_hm = 0.5,                # Transmission probability human to mosquito
beta_mh = 0.5,                # Transmission probability mosquito to human
# We'll use the normalized rain_norm values we created earlier
r1  = rainfall_data$rain_norm[1], r2  = rainfall_data$rain_norm[2],
r3  = rainfall_data$rain_norm[3], r4  = rainfall_data$rain_norm[4],
r5  = rainfall_data$rain_norm[5], r6  = rainfall_data$rain_norm[6],
r7  = rainfall_data$rain_norm[7], r8  = rainfall_data$rain_norm[8],
r9  = rainfall_data$rain_norm[9], r10 = rainfall_data$rain_norm[10],
r11 = rainfall_data$rain_norm[11], r12 = rainfall_data$rain_norm[12]
)
time <- 0:(365*10)
rainfall_data <- data.frame(
month = 1:12,
rainfall = c(0.38, 1.52, 6.49, 29.32, 64.98, 109.02,
176.81, 240.86, 148.25, 49.59, 3.58, 0.25)
)
# Convert month to day-of-year (mid-month approximation)
rainfall_data$day <- (rainfall_data$month - 0.5) * (365 / 12)
# Normalize rainfall (important!)
rainfall_data$rain_norm <- rainfall_data$rainfall / max(rainfall_data$rainfall)
# Interpolated rainfall function (periodic)
rainfall_fun <- approxfun(
x = rainfall_data$day,
y = rainfall_data$rain_norm,
rule = 2
)
# Periodic wrapper (repeats every year)
rainfall <- function(t) {
rainfall_fun((t %% 365))
}
# Initial conditions
N1_initial <- 900000  # Initial population age group 1
N2_initial <- 100000  # Initial population age group 2
initial_conditions <- c(
S1 = N1_initial - 200,    # Susceptible age group 1;200
E1 = 0,                  # Exposed age group 1
S2 = N2_initial - 100,     # Susceptible age group 2;50
E2 = 0,                  # Exposed age group 2
Im = 500,                  # Infectious mild (mixed ages)
Is = 42,                  # Infectious severe (mixed ages)
C = 0,                   # Chronic
R = 0,                   # Recovered
V = 0,                   # Vaccinated
Sm = 10000,               # Susceptible mosquitoes;9000
Em = 1000,                # Exposed mosquitoes
Im_mosq = 100,            # Infectious mosquitoes
CumInc = 0
)
reactions<- list (
#Age-group 1 Vaccination
reaction(~ vaccination_rate_1 * S1, c(S1=-1, V= +1)),
#Age-group 2 Vaccination
reaction(~ vaccination_rate_2 * S2, c(S2 =-1,V =+1)),
#Age-group 1
reaction(
~ (1 + amp * cos(2 * PI * (fmod(time , 365.0)/365.0 - phi)))* (b * beta_mh * Im_mosq / (S1+E1+S2+E2+V+Im+Is+C+R)) *contact_rate_1 * S1, c(S1 = -1, E1 = +1, CumInc = +1)),
reaction(~ mu * (S1+E1+Im+Is+C+R), c(S1 =+1)), # Birth (approx)
reaction(~ mu * S1, c( S1= -1)),   #Natural Death S1
#Progression Age Group 1
reaction ( ~ sigma * (1- severe_prob_1)* E1, c(E1 = -1,Im = +1)),
reaction(~sigma * severe_prob_1 *E1, c(E1 = -1, Is = +1)),
#Age-Group 2
reaction(
~ (1 + amp * cos(2 * PI * (fmod(time , 365.0)/365.0 - phi))) * (b * beta_mh * Im_mosq / (S1+E1+S2+E2+V+Im+Is+C+R)) * contact_rate_2 * S2, c(S2 = -1, E2 = +1, CumInc =+1)),
reaction(~ mu * S2, c(S2 = -1)),
# Progression Age Group 2
reaction(~ sigma * (1 - severe_prob_2) * E2, c(E2 = -1, Im = +1)),
reaction(~ sigma * severe_prob_2 * E2, c(E2 = -1, Is = +1)),
#reaction(~import_rate, c(E1=+1)),
reaction(~import_rate * 10, c(E1=+1)),
reaction(~import_rate , c(E2 =+1)),
# --- Natural Death for Vaccinated ---
reaction(~ mu * V, c(V = -1)),
# Recovery & Chronic Transitions
reaction(~ gamma_m * Im, c(Im = -1, R = +1)),
reaction(~ mu_ms * Im, c(Im = -1, Is = +1)), # Progression mild to severe
reaction(~ (1 - chronic_prob_s) * gamma_s * Is, c(Is = -1, R = +1)),
reaction(~ chronic_prob_s * gamma_s * Is, c(Is = -1, C = +1)),
reaction(~ gamma_c * C, c(C = -1, R = +1)),
# Mosquito Lifecycle
reaction(
~ (b * beta_hm * (Im + Is) / (S1+E1+S2+E2+V+Im+Is+C+R)) * Sm,
c(Sm = -1, Em = +1)
),
reaction(~ sigma_m * Em, c(Em = -1, Im_mosq = +1)),
reaction(~ 10, c(Im_mosq = +1)),
# ✅ Rainfall-driven mosquito recruitment
# ✅ Balanced Rainfall-driven mosquito recruitment
reaction(
~ 10000 + (Lambda_m * mu_m * (1 + amp * (
(fmod(time, 365.0) < 30.4)  * r1 +
(fmod(time, 365.0) >= 30.4  && fmod(time, 365.0) < 60.8)  * r2 +
(fmod(time, 365.0) >= 60.8  && fmod(time, 365.0) < 91.2)  * r3 +
(fmod(time, 365.0) >= 91.2  && fmod(time, 365.0) < 121.6) * r4 +
(fmod(time, 365.0) >= 121.6 && fmod(time, 365.0) < 152.0) * r5 +
(fmod(time, 365.0) >= 152.0 && fmod(time, 365.0) < 182.4) * r6 +
(fmod(time, 365.0) >= 182.4 && fmod(time, 365.0) < 212.8) * r7 +
(fmod(time, 365.0) >= 212.8 && fmod(time, 365.0) < 243.2) * r8 +
(fmod(time, 365.0) >= 243.2 && fmod(time, 365.0) < 273.6) * r9 +
(fmod(time, 365.0) >= 273.6 && fmod(time, 365.0) < 304.0) * r10 +
(fmod(time, 365.0) >= 304.0 && fmod(time, 365.0) < 334.4) * r11 +
(fmod(time, 365.0) >= 334.4) * r12
))),
c(Sm = +1)
),
# Mosquito death
reaction(~ mu_m * Sm, c(Sm = -1)),
reaction(~ mu_m * Em, c(Em = -1)),
reaction(~ mu_m * Im_mosq, c(Im_mosq = -1))
)
set.seed(123) #For reproducibility
out <- ssa(
initial_state = initial_conditions,
reactions = reactions,
params = unlist(params),
final_time = 365 * 10,
method = ssa_etl(tau = 0.1)
)
# Plotting ----------------------------------------------------------------
out_df <- as.data.frame(out$state)
out_df$time <- out$time
out_df$I_total <- out_df$Im + out_df$Is
ggplot(out_df, aes(time, I_total)) +
geom_step() +
theme_minimal() +
labs(
title = "Stochastic Chikungunya with Rainfall-Driven Mosquito Recruitment",
x = "Time (days)",
y = "Total infectious"
)
plot_data <- out_df %>%
select(time, S1, E1, S2, E2) %>%
pivot_longer(cols = -time,
names_to = "Compartment",
values_to = "Count")
ggplot(plot_data, aes(x=time, y= Count, color= Compartment))+
geom_step()+
facet_wrap(~Compartment, scales = "free_y")+
theme_minimal()+
labs(title = "Stochastic Chikunginua Simulation", c= "Days", y = "Count")
out_df <- as.data.frame(out$state)
out_df$time <- out$time   #as.numeric(rownames(out_df))
# plot human compartments including Vaccination ---------------------------
human_df <- out_df %>%
mutate(
I_total = Im + Is
) %>%
select(time, I_total, C, R, V) %>% # <--- Added V here
pivot_longer(-time, names_to = "compartment", values_to = "count")
ggplot(human_df, aes(x = time, y = count, color = compartment)) +
geom_step(linewidth = 1) +
labs(
title = "Stochastic Chikungunya Dynamics (Humans with Vaccination)",
x = "Time (days)",
y = "Population count"
) +
theme_minimal()
inf_df <- out_df %>%
select(time, Im, Is) %>%
pivot_longer(-time, names_to = "infection_type", values_to = "count")
ggplot(inf_df, aes(x = time, y = count, color = infection_type)) +
geom_step(linewidth = 1.1) +
labs(
title = "Mild vs Severe Infections (Stochastic)",
x = "Time (days)",
y = "Number of individuals"
) +
theme_minimal()
mosq_df <- out_df %>%
select(time, Sm, Em, Im_mosq) %>%
pivot_longer(-time, names_to = "compartment", values_to = "count")
ggplot(mosq_df, aes(x = time, y = count, color = compartment)) +
geom_step(linewidth = 0.5) +
labs(
title = "Mosquito Population Dynamics",
x = "Time (days)",
y = "Mosquito count"
) +
theme_minimal()
run_single_sim <- function(rate, label, seed) {
current_params <- params
current_params$vaccination_rate_1 <- rate
current_params$vaccination_rate_2 <- rate
set.seed(seed)
sim_out <- ssa(
initial_state = initial_conditions,
reactions = reactions,
params = unlist(current_params),
final_time = 365 * 10,
method = ssa_exact()
)
df <- as.data.frame(sim_out$state)
df$time_days <- sim_out$time
df$I_total <- df$Im + df$Is
df$Scenario <- label
df
}
scenarios <- list(
"No vaccination" = 0,
"20% Vaccination" = 0.0012,
"30% Vaccination" = 0.0025,
"40% Vaccination" = 0.0050
)
n_sims <- 100  # increase if you want smoother CIs
all_runs <- lapply(names(scenarios), function(scn) {
rate <- scenarios[[scn]]
lapply(1:n_sims, function(i) {
run_single_sim(rate, scn, seed = 1000 + i)
}) %>% bind_rows()
}) %>% bind_rows()
n_sims <- 20  # increase if you want smoother CIs
all_runs <- lapply(names(scenarios), function(scn) {
rate <- scenarios[[scn]]
lapply(1:n_sims, function(i) {
run_single_sim(rate, scn, seed = 1000 + i)
}) %>% bind_rows()
}) %>% bind_rows()
n_sims <- 20  # increase if you want smoother CIs
all_runs <- lapply(names(scenarios), function(scn) {
rate <- scenarios[[scn]]
lapply(1:n_sims, function(i) {
run_single_sim(rate, scn, seed = 1000 + i)
}) %>% bind_rows()
}) %>% bind_rows()
library(purrr)
# 1. Define vaccination scenarios
scenarios <- list(
"No Vaccination" = 0,
"20% Vaccination" = 0.0012,
"30% Vaccination" = 0.0025,
"40% Vaccination" = 0.0050
)
# 2. Function to run multiple replicates for a scenario
run_replicates <- function(rate, label, n_reps = 5) {
current_params <- params
current_params$vaccination_rate_1 <- rate
current_params$vaccination_rate_2 <- rate
# Map through replicates
map_df(1:n_reps, function(rep_id) {
# Using different seeds for each replicate to capture stochasticity
set.seed(rep_id * 100)
sim_out <- ssa(
initial_state = initial_conditions,
reactions = reactions,
params = unlist(current_params),
final_time = 365 * 10,
method = ssa_etl(tau = 0.5) # ETL is necessary for speed with replicates
)
# Create a standardized time grid for averaging (every 5 days)
time_grid <- seq(0, 365 * 10, by = 5)
# Interpolate results to fit the grid
interp_vals <- approx(sim_out$time, (sim_out$state[, "Im"] + sim_out$state[, "Is"]), xout = time_grid)$y
data.frame(
time = time_grid,
I_total = interp_vals,
Scenario = label,
replicate = rep_id
)
})
}
# 3. Run all scenarios (this may take a few minutes)
all_data <- imap_dfr(scenarios, ~run_replicates(.x, .y))
# 4. Calculate Mean and Confidence Intervals (95% CI)
summary_df <- all_data %>%
group_by(Scenario, time) %>%
summarise(
mean_inf = mean(I_total, na.rm = TRUE),
sd_inf = sd(I_total, na.rm = TRUE),
n = n(),
.groups = "drop"
) %>%
mutate(
se = sd_inf / sqrt(n),
lower = mean_inf - (1.96 * se),
upper = mean_inf + (1.96 * se),
# Convert days to Months starting from Jan 2025
Date = 2025 + (time / 365),
Month_Total = time / (365/12)
)
# 5. Plotting
ggplot(summary_df, aes(x = Month_Total, y = mean_inf, color = Scenario, fill = Scenario)) +
geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.4, color = NA) +
geom_line(linewidth = 1) +
scale_x_continuous(
breaks = seq(0, 120, by = 12),
labels = function(x) paste0("Yr ", (x/12) + 2025)
) +
theme_minimal() +
labs(
title = "Chikungunya Projection (2025-2035): Vaccination Impact",
subtitle = "Mean trajectories with 95% Confidence Intervals (5 replicates per scenario)",
x = "Year",
y = "Total Infectious Population",
fill = "Scenario",
color = "Scenario"
) +
scale_color_brewer(palette = "Set1") +
scale_fill_brewer(palette = "Set1")+
theme(axis.text.x = element_text(angle = 45, hjust = 1))
run_single_sim <- function(rate, label, seed) {
current_params <- params
current_params$vaccination_rate_1 <- rate
current_params$vaccination_rate_2 <- rate
set.seed(seed)
sim_out <- ssa(
initial_state = initial_conditions,
reactions = reactions,
params = unlist(current_params),
final_time = 365 * 10,
method = ssa_exact()
)
df <- as.data.frame(sim_out$state)
df$time_days <- sim_out$time
df$I_total <- df$Im + df$Is
df$Scenario <- label
df
}
scenarios <- list(
"No vaccination" = 0,
"20% Vaccination" = 0.0012,
"30% Vaccination" = 0.0025,
"40% Vaccination" = 0.0050
)
n_sims <- 20  # increase if you want smoother CIs
all_runs <- lapply(names(scenarios), function(scn) {
rate <- scenarios[[scn]]
lapply(1:n_sims, function(i) {
run_single_sim(rate, scn, seed = 1000 + i)
}) %>% bind_rows()
}) %>% bind_rows()
# Load Libraries ----------------------------------------------------------
# Run this immediately after restarting R
options(max.external.libraries = 200)
n_sims <- 20  # increase if you want smoother CIs
all_runs <- lapply(names(scenarios), function(scn) {
rate <- scenarios[[scn]]
lapply(1:n_sims, function(i) {
run_single_sim(rate, scn, seed = 1000 + i)
}) %>% bind_rows()
}) %>% bind_rows()
