scenarios <- list(
"20% Vaccination" = 0.0012,
"30% Vaccination" = 0.0025,
"40% Vaccination" = 0.0050
)
# Function to run simulation for a specific rate
run_scenario <- function(rate, label) {
current_params <- params
current_params$vaccination_rate_1 <- rate
current_params$vaccination_rate_2 <- rate
set.seed(123)
sim_out <- ssa(
initial_state = initial_conditions,
reactions = reactions,
params = unlist(current_params),
final_time = 365 * 10,
method = ssa_exact()
)
df <- as.data.frame(sim_out$state)
df$time <- sim_out$time
df$Scenario <- label
df$I_total <- df$Im + df$Is
return(df)
}
# Run all scenarios and combine
all_scenarios_df <- lapply(names(scenarios), function(n) {
run_scenario(scenarios[[n]], n)
}) %>% bind_rows()
# Plot Comparison
ggplot(all_scenarios_df, aes(x = time, y = I_total, color = Scenario)) +
geom_line(alpha = 0.7) +
theme_minimal() +
labs(
title = "Impact of Vaccination Coverage on Total Infectious Population",
subtitle = "Stochastic comparison of 20%, 30%, and 40% scenarios",
x = "Time (days)",
y = "Total Infectious Humans"
) +
scale_color_brewer(palette = "Set1")
library(purrr)
# 1. Define vaccination scenarios
scenarios <- list(
"No Vaccination" = 0,
"20% Vaccination" = 0.0012,
"30% Vaccination" = 0.0025,
"40% Vaccination" = 0.0050
)
# 2. Function to run multiple replicates for a scenario
run_replicates <- function(rate, label, n_reps = 5) {
current_params <- params
current_params$vaccination_rate_1 <- rate
current_params$vaccination_rate_2 <- rate
# Map through replicates
map_df(1:n_reps, function(rep_id) {
# Using different seeds for each replicate to capture stochasticity
set.seed(rep_id * 100)
sim_out <- ssa(
initial_state = initial_conditions,
reactions = reactions,
params = unlist(current_params),
final_time = 365 * 10,
method = ssa_etl(tau = 0.5) # ETL is necessary for speed with replicates
)
# Create a standardized time grid for averaging (every 5 days)
time_grid <- seq(0, 365 * 10, by = 5)
# Interpolate results to fit the grid
interp_vals <- approx(sim_out$time, (sim_out$state[, "Im"] + sim_out$state[, "Is"]), xout = time_grid)$y
data.frame(
time = time_grid,
I_total = interp_vals,
Scenario = label,
replicate = rep_id
)
})
}
# 3. Run all scenarios (this may take a few minutes)
all_data <- imap_dfr(scenarios, ~run_replicates(.x, .y))
# 4. Calculate Mean and Confidence Intervals (95% CI)
summary_df <- all_data %>%
group_by(Scenario, time) %>%
summarise(
mean_inf = mean(I_total, na.rm = TRUE),
sd_inf = sd(I_total, na.rm = TRUE),
n = n(),
.groups = "drop"
) %>%
mutate(
se = sd_inf / sqrt(n),
lower = mean_inf - (1.96 * se),
upper = mean_inf + (1.96 * se),
# Convert days to Months starting from Jan 2025
Date = 2025 + (time / 365),
Month_Total = time / (365/12)
)
# 5. Plotting
ggplot(summary_df, aes(x = Month_Total, y = mean_inf, color = Scenario, fill = Scenario)) +
geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.4, color = NA) +
geom_line(linewidth = 1) +
scale_x_continuous(
breaks = seq(0, 120, by = 12),
labels = function(x) paste0("Yr ", (x/12) + 2025)
) +
theme_minimal() +
labs(
title = "Chikungunya Projection (2025-2035): Vaccination Impact",
subtitle = "Mean trajectories with 95% Confidence Intervals (5 replicates per scenario)",
x = "Year",
y = "Total Infectious Population",
fill = "Scenario",
color = "Scenario"
) +
scale_color_brewer(palette = "Set1") +
scale_fill_brewer(palette = "Set1")+
theme(axis.text.x = element_text(angle = 45, hjust = 1))
runs <- 100
target_times <- seq(0, 365 * 10, by = 1)
multi_out <- lapply(1:runs, function(i){
sim <- ssa(
initial_state = initial_conditions,
reactions = reactions,
params = unlist(params),
final_time = 365 * 10,
method = ssa_exact()
)
# Create a full dataframe
full_df <- as.data.frame(sim$state)
full_df$time <- sim$time
# THINNING: Use approx to find the state values at our target_times
# This reduces millions of rows down to exactly 3651 rows per run
thinned_df <- data.frame(time = target_times, run = i)
# Interpolate each compartment (S1, E1, Im, Is, etc.)
# Using method = "constant" preserves the 'step' nature of Gillespie
compartments <- names(initial_conditions)
for(comp in compartments) {
thinned_df[[comp]] <- approx(x = full_df$time, y = full_df[[comp]],
xout = target_times, method = "constant",
rule = 2)$y
}
return(thinned_df)
})
multi_df <- bind_rows(multi_out)
multi_df <- multi_df %>%
mutate(I_total = Im + Is)
# 3. Plot
ggplot(multi_df, aes(x = time, y = I_total, group = run)) +
geom_step(alpha = 0.2, color = "steelblue") +
labs(
title = "Stochastic Variability in Total Infections",
subtitle = paste("10-year simulation across", runs, "runs"),
x = "Time (days)",
y = "Total Infectious (Mild + Severe)"
) +
theme_minimal()
multi_df <- multi_df %>%
mutate(
I_total = Im + Is,
time_months = time / 30.4375,
calendar_year = 2025 + time / 365
)
# 3. Plot
ggplot(multi_df, aes(x = time_months, y = I_total, group = run)) +
geom_step(alpha = 0.15, color = "steelblue") +
theme_minimal() +
labs(
title = "Stochastic Variability in Total Chikungunya Infections",
subtitle = paste("10-year simulation starting 2025 |", runs, "SSA runs"),
x = "Time since 2025 (months)",
y = "Total Infectious (Mild + Severe)"
) +
xlim(0, 120)
library(purrr)
# 1. Define vaccination scenarios
scenarios <- list(
"No Vaccination" = 0,
"20% Vaccination" = 0.0012,
"30% Vaccination" = 0.0025,
"40% Vaccination" = 0.0050
)
# 2. Function to run multiple replicates for a scenario
run_replicates <- function(rate, label, n_reps = 10) {
current_params <- params
current_params$vaccination_rate_1 <- rate
current_params$vaccination_rate_2 <- rate
# Map through replicates
map_df(1:n_reps, function(rep_id) {
# Using different seeds for each replicate to capture stochasticity
set.seed(rep_id * 100)
sim_out <- ssa(
initial_state = initial_conditions,
reactions = reactions,
params = unlist(current_params),
final_time = 365 * 10,
method = ssa_etl(tau = 0.5) # ETL is necessary for speed with replicates
)
# Create a standardized time grid for averaging (every 5 days)
time_grid <- seq(0, 365 * 10, by = 5)
# Interpolate results to fit the grid
interp_vals <- approx(sim_out$time, (sim_out$state[, "Im"] + sim_out$state[, "Is"]), xout = time_grid)$y
data.frame(
time = time_grid,
I_total = interp_vals,
Scenario = label,
replicate = rep_id
)
})
}
# 3. Run all scenarios (this may take a few minutes)
all_data <- imap_dfr(scenarios, ~run_replicates(.x, .y))
# 4. Calculate Mean and Confidence Intervals (95% CI)
summary_df <- all_data %>%
group_by(Scenario, time) %>%
summarise(
mean_inf = mean(I_total, na.rm = TRUE),
sd_inf = sd(I_total, na.rm = TRUE),
n = n(),
.groups = "drop"
) %>%
mutate(
se = sd_inf / sqrt(n),
lower = mean_inf - (1.96 * se),
upper = mean_inf + (1.96 * se),
# Convert days to Months starting from Jan 2025
Date = 2025 + (time / 365),
Month_Total = time / (365/12)
)
# 5. Plotting
ggplot(summary_df, aes(x = Month_Total, y = mean_inf, color = Scenario, fill = Scenario)) +
geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.4, color = NA) +
geom_line(linewidth = 1) +
scale_x_continuous(
breaks = seq(0, 120, by = 12),
labels = function(x) paste0("Yr ", (x/12) + 2025)
) +
theme_minimal() +
labs(
title = "Chikungunya Projection (2025-2035): Vaccination Impact",
subtitle = "Mean trajectories with 95% Confidence Intervals (5 replicates per scenario)",
x = "Year",
y = "Total Infectious Population",
fill = "Scenario",
color = "Scenario"
) +
scale_color_brewer(palette = "Set1") +
scale_fill_brewer(palette = "Set1")+
theme(axis.text.x = element_text(angle = 45, hjust = 1))
# 2. Function to run multiple replicates for a scenario
run_replicates <- function(rate, label, n_reps = 20) {
current_params <- params
current_params$vaccination_rate_1 <- rate
current_params$vaccination_rate_2 <- rate
# Map through replicates
map_df(1:n_reps, function(rep_id) {
# Using different seeds for each replicate to capture stochasticity
set.seed(rep_id * 100)
sim_out <- ssa(
initial_state = initial_conditions,
reactions = reactions,
params = unlist(current_params),
final_time = 365 * 10,
method = ssa_etl(tau = 0.5) # ETL is necessary for speed with replicates
)
# Create a standardized time grid for averaging (every 5 days)
time_grid <- seq(0, 365 * 10, by = 5)
# Interpolate results to fit the grid
interp_vals <- approx(sim_out$time, (sim_out$state[, "Im"] + sim_out$state[, "Is"]), xout = time_grid)$y
data.frame(
time = time_grid,
I_total = interp_vals,
Scenario = label,
replicate = rep_id
)
})
}
# 3. Run all scenarios (this may take a few minutes)
all_data <- imap_dfr(scenarios, ~run_replicates(.x, .y))
# 4. Calculate Mean and Confidence Intervals (95% CI)
summary_df <- all_data %>%
group_by(Scenario, time) %>%
summarise(
mean_inf = mean(I_total, na.rm = TRUE),
sd_inf = sd(I_total, na.rm = TRUE),
n = n(),
.groups = "drop"
) %>%
mutate(
se = sd_inf / sqrt(n),
lower = mean_inf - (1.96 * se),
upper = mean_inf + (1.96 * se),
# Convert days to Months starting from Jan 2025
Date = 2025 + (time / 365),
Month_Total = time / (365/12)
)
# 5. Plotting
ggplot(summary_df, aes(x = Month_Total, y = mean_inf, color = Scenario, fill = Scenario)) +
geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.4, color = NA) +
geom_line(linewidth = 1) +
scale_x_continuous(
breaks = seq(0, 120, by = 12),
labels = function(x) paste0("Yr ", (x/12) + 2025)
) +
theme_minimal() +
labs(
title = "Chikungunya Projection (2025-2035): Vaccination Impact",
subtitle = "Mean trajectories with 95% Confidence Intervals (5 replicates per scenario)",
x = "Year",
y = "Total Infectious Population",
fill = "Scenario",
color = "Scenario"
) +
scale_color_brewer(palette = "Set1") +
scale_fill_brewer(palette = "Set1")+
theme(axis.text.x = element_text(angle = 45, hjust = 1))
# 5. Plotting
ggplot(summary_df, aes(x = Month_Total, y = mean_inf, color = Scenario, fill = Scenario)) +
geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.4, color = NA) +
geom_line(linewidth = 1) +
scale_x_continuous(
breaks = seq(0, 120, by = 12),
labels = function(x) paste0("Yr ", (x/12) + 2025)
) +
theme_minimal() +
labs(
title = "Chikungunya Projection (2025-2035): Vaccination Impact",
subtitle = "Mean trajectories with 95% Confidence Intervals (20 replicates per scenario)",
x = "Year",
y = "Total Infectious Population",
fill = "Scenario",
color = "Scenario"
) +
scale_color_brewer(palette = "Set1") +
scale_fill_brewer(palette = "Set1")+
theme(axis.text.x = element_text(angle = 45, hjust = 1))
# 2. Function to run multiple replicates for a scenario
run_replicates <- function(rate, label, n_reps = 50) {
current_params <- params
current_params$vaccination_rate_1 <- rate
current_params$vaccination_rate_2 <- rate
# Map through replicates
map_df(1:n_reps, function(rep_id) {
# Using different seeds for each replicate to capture stochasticity
set.seed(rep_id * 100)
sim_out <- ssa(
initial_state = initial_conditions,
reactions = reactions,
params = unlist(current_params),
final_time = 365 * 10,
method = ssa_etl(tau = 0.5) # ETL is necessary for speed with replicates
)
# Create a standardized time grid for averaging (every 5 days)
time_grid <- seq(0, 365 * 10, by = 5)
# Interpolate results to fit the grid
interp_vals <- approx(sim_out$time, (sim_out$state[, "Im"] + sim_out$state[, "Is"]), xout = time_grid)$y
data.frame(
time = time_grid,
I_total = interp_vals,
Scenario = label,
replicate = rep_id
)
})
}
# 3. Run all scenarios (this may take a few minutes)
all_data <- imap_dfr(scenarios, ~run_replicates(.x, .y))
# 4. Calculate Mean and Confidence Intervals (95% CI)
summary_df <- all_data %>%
group_by(Scenario, time) %>%
summarise(
mean_inf = mean(I_total, na.rm = TRUE),
sd_inf = sd(I_total, na.rm = TRUE),
n = n(),
.groups = "drop"
) %>%
mutate(
se = sd_inf / sqrt(n),
lower = mean_inf - (1.96 * se),
upper = mean_inf + (1.96 * se),
# Convert days to Months starting from Jan 2025
Date = 2025 + (time / 365),
Month_Total = time / (365/12)
)
# 5. Plotting
ggplot(summary_df, aes(x = Month_Total, y = mean_inf, color = Scenario, fill = Scenario)) +
geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.4, color = NA) +
geom_line(linewidth = 1) +
scale_x_continuous(
breaks = seq(0, 120, by = 12),
labels = function(x) paste0("Yr ", (x/12) + 2025)
) +
theme_minimal() +
labs(
title = "Chikungunya Projection (2025-2035): Vaccination Impact",
subtitle = "Mean trajectories with 95% Confidence Intervals (20 replicates per scenario)",
x = "Year",
y = "Total Infectious Population",
fill = "Scenario",
color = "Scenario"
) +
scale_color_brewer(palette = "Set1") +
scale_fill_brewer(palette = "Set1")+
theme(axis.text.x = element_text(angle = 45, hjust = 1))
# 2. Function to run multiple replicates for a scenario
run_replicates <- function(rate, label, n_reps = 15) {
current_params <- params
current_params$vaccination_rate_1 <- rate
current_params$vaccination_rate_2 <- rate
# Map through replicates
map_df(1:n_reps, function(rep_id) {
# Using different seeds for each replicate to capture stochasticity
set.seed(rep_id * 100)
sim_out <- ssa(
initial_state = initial_conditions,
reactions = reactions,
params = unlist(current_params),
final_time = 365 * 10,
method = ssa_etl(tau = 0.5) # ETL is necessary for speed with replicates
)
# Create a standardized time grid for averaging (every 5 days)
time_grid <- seq(0, 365 * 10, by = 5)
# Interpolate results to fit the grid
interp_vals <- approx(sim_out$time, (sim_out$state[, "Im"] + sim_out$state[, "Is"]), xout = time_grid)$y
data.frame(
time = time_grid,
I_total = interp_vals,
Scenario = label,
replicate = rep_id
)
})
}
# 3. Run all scenarios (this may take a few minutes)
all_data <- imap_dfr(scenarios, ~run_replicates(.x, .y))
# 4. Calculate Mean and Confidence Intervals (95% CI)
summary_df <- all_data %>%
group_by(Scenario, time) %>%
summarise(
mean_inf = mean(I_total, na.rm = TRUE),
sd_inf = sd(I_total, na.rm = TRUE),
n = n(),
.groups = "drop"
) %>%
mutate(
se = sd_inf / sqrt(n),
lower = mean_inf - (1.96 * se),
upper = mean_inf + (1.96 * se),
# Convert days to Months starting from Jan 2025
Date = 2025 + (time / 365),
Month_Total = time / (365/12)
)
# Aggregate and plot human compartments ----------------------------------
human_df <- out_df %>%
mutate(
# Aggregating groups for a cleaner report-ready plot
Susceptible = S1 + S2,
Exposed = E1 + E2,
Infected = Im + Is,
Recovered = R,
Vaccinated = V
) %>%
# Select the time variable and your new aggregated columns
select(time_months, Susceptible, Exposed, Infected, Recovered, Vaccinated) %>%
pivot_longer(
cols = -time_months,
names_to = "compartment",
values_to = "count"
)
ggplot(human_df, aes(x = time_months, y = count, color = compartment)) +
geom_step(linewidth = 1) +
theme_minimal() +
labs(
title = "Stochastic Chikungunya Dynamics: Total Human Population (2025-2035)",
subtitle = "Aggregated age groups for Susceptible and Exposed compartments",
x = "Months since Jan 2025",
y = "Population Count",
color = "State"
) +
scale_x_continuous(limits = c(0, 120), breaks = seq(0, 120, by = 12)) +
# Use a color palette that makes the different lines easy to distinguish
scale_color_brewer(palette = "Set1")
stochastic_human_df <- multi_df %>%
mutate(
Susceptible = S1 + S2,
Exposed = E1 + E2,
Infected = Im + Is,
Recovered = R,
Vaccinated = V
) %>%
select(time_months, run, Susceptible, Exposed, Infected, Recovered, Vaccinated) %>%
pivot_longer(
cols = c(Susceptible, Exposed, Infected, Recovered, Vaccinated),
names_to = "compartment",
values_to = "count"
)
# 2. Plotting with geom_step to show discrete stochastic jumps
ggplot(stochastic_human_df, aes(x = time_months, y = count, group = interaction(run, compartment), color = compartment)) +
# Using a very low alpha to show the "cloud" of stochastic paths
geom_step(alpha = 0.1) +
theme_minimal() +
labs(
title = "Stochastic Human Dynamics: 100 Simulation Realizations",
subtitle = "Discrete step-functions showing population transitions (2025-2035)",
x = "Months since Jan 2025",
y = "Population Count",
color = "State"
) +
scale_x_continuous(limits = c(0, 120), breaks = seq(0, 120, by = 12)) +
# Use a bold color palette to distinguish the overlapping clouds
scale_color_manual(values = c(
"Susceptible" = "#E41A1C",
"Exposed" = "#377EB8",
"Infected" = "#4DAF4A",
"Recovered" = "#984EA3",
"Vaccinated" = "#FF7F00"
)) +
guides(color = guide_legend(override.aes = list(alpha = 1))) # Make legend opaque
